# Contributor: Markus Heuser <markus.heuser@web.de>
# Contributor: Christian Krause ("wookietreiber") <kizkizzbangbang@googlemail.com>
# Maintainer: Thiago Yukio Kikuchi Oliveira <stratust@gmail.com>

pkgname=samtools
pkgver=1.0
pkgrel=1
pkgdesc="tools for manipulating next-generation sequencing data"
arch=('i686' 'x86_64')
url="http://samtools.sourceforge.net/"
license=('custom')
depends=('perl' 'htslib')
optdepends=('luajit: needed for r2plot.lua vcfutils.lua'
            'python2: needed for varfilter.py')
options=('staticlibs')
source=("$pkgname-$pkgver.tar.gz::https://github.com/samtools/samtools/archive/$pkgver.tar.gz"
        'system-htslib.patch')
md5sums=('7eff9d605f21b0910887424069bae72e'
         'SKIP')

prepare() {
  cd "$srcdir/$pkgname-$pkgver"

  patch -p1 -i "$srcdir/system-htslib.patch"

  # sed -i 's?/software/bin/python?/usr/bin/python2?' misc/varfilter.py

  # sed -e 's?include $(HTSDIR)/htslib.mk??g' \
  #     -e 's?$(HTSLIB)??g' \
  #     -e 's?check test: samtools $(BGZIP)?check test: samtools?' \
  #     -e 's?$(BGZIP)?/usr/bin/bgzip?g' \
  #     -e 's?$(HTSDIR)/htslib/kfunc.h??g' \
  #     -e 's?$(HTSDIR)/htslib/khash.h??g' \
  #     -e 's?$(HTSDIR)/htslib/khash_str2int.h??g' \
  #     -e 's?$(HTSDIR)/htslib/klist.h??g' \
  #     -e 's?$(HTSDIR)/htslib/kseq.h??g' \
  #     -e 's?$(HTSDIR)/htslib/ksort.h??g' \
  #     -e 's?$(HTSDIR)/htslib/kstring.h??g' \
  #     -i Makefile
}

build() {
  cd "$srcdir/$pkgname-$pkgver"

  # CXXFLAGS=-fPIC CFLAGS=-fPIC CPPFLAGS=-fPIC
  # make HTSDIR="/usr/include" HTSLIB="/usr/lib/libhts.so" BGZIP="/usr/bin/bgzip" LDLIBS="-lhts"
  make LDLIBS="-lhts"
}

check() {
  cd "$srcdir/$pkgname-$pkgver"

  make check
}

package() {
  cd "$srcdir/$pkgname-$pkgver"

  make DESTDIR="$pkgdir" prefix=/usr install

  install -Dm644 libbam.a "$pkgdir/usr/lib/libbam.a"

  install -Dm644 LICENSE "$pkgdir/usr/share/licenses/$pkgname/LICENSE"
}
